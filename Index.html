<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TED demo – vembudar.se</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    button { padding: 10px 16px; cursor: pointer; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-top:16px; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <h1>TED API – enkel fetch</h1>
  <p class="muted">Hämtar senaste publicerade upphandlingar i <strong>Sverige</strong> (över EU:s tröskel, publicerade i TED).</p>

  <button id="load">Hämta 1 upphandling</button>

  <div id="notice" class="card" hidden></div>
  <h3>Rådata</h3>
  <pre id="raw">[inget än]</pre>

  <script>
  async function fetchTed() {
    const endpoint = 'https://api.ted.europa.eu/v3/notices/search';

    // Minimal sökkropp: land = SE, sortera på publiceringsdatum, ta 1 träff.
    // (Om du vill: lägg till fler filter senare, t.ex. CPV/NUTS/deadline.)
    const body = {
      q: 'country:SE',            // Expert query-sträng – kan utökas med AND/OR
      pageSize: 1,                // hur många notices
      pageNum: 1,                 // sida
      sort: 'publicationDate,desc'
      // fields: kan utelämnas; API returnerar standardfält
    };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`HTTP ${res.status} – ${t}`);
    }

    const json = await res.json();

    // Visa rådata
    document.getElementById('raw').textContent = JSON.stringify(json, null, 2);

    // Försök plocka ut första notice: vissa fältnamn kan variera → defensiv kod
    const first =
      (json.results && json.results[0]) ||
      (json.items && json.items[0]) ||
      (Array.isArray(json) ? json[0] : null);

    const box = document.getElementById('notice');
    if (!first) {
      box.innerHTML = '<strong>Ingen träff</strong>';
      box.hidden = false;
      return;
    }

    // Vanliga fält (kan heta lite olika beroende på version); optional chaining
    const title = first.title?.text || first.title || first.TI || 'Utan titel';
    const buyer = first.buyer?.name || first.buyerName || first.BN || 'Okänd upphandlare';
    const pubDate = first.publicationDate || first.PD || first.datePublished || '';
    const deadline = first.deadlineDate || first.deadline || first.DD || '';
    const tedUrl =
      first.viewUrl || first.tedUrl || first.url || first.link ||
      (first.ND ? `https://ted.europa.eu/en/notice/-/detail/${first.ND}` : null);

    box.innerHTML = `
      <div><strong>${title}</strong></div>
      <div class="muted">${buyer}</div>
      <div>Publicerad: ${pubDate || '—'}</div>
      <div>Sista anbudsdag: ${deadline || '—'}</div>
      <div>${tedUrl ? `<a href="${tedUrl}" target="_blank" rel="noopener">Öppna på TED</a>` : ''}</div>
    `;
    box.hidden = false;
  }

  document.getElementById('load').addEventListener('click', async () => {
    const btn = document.getElementById('load');
    btn.disabled = true;
    btn.textContent = 'Hämtar...';
    try {
      await fetchTed();
    } catch (e) {
      document.getElementById('raw').textContent = 'Fel: ' + e.message;
    } finally {
      btn.disabled = false;
      btn.textContent = 'Hämta 1 upphandling';
    }
  });
  </script>
</body>
</html>
