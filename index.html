<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8" />
    <title>3D Bilspel</title>
    <!-- Ladda in Three.js från CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #333;
            touch-action: none; /* För att kunna hantera egen touch/drag */
            user-select: none; /* Undvik att markera text när man drar */
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-family: sans-serif;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div id="info">Level: <span id="levelText">1</span> | Poäng: <span id="scoreText">0</span></div>
    <script>
    // ---------------------------------------------------
    // Variabler
    // ---------------------------------------------------
    let scene, camera, renderer;
    let car;                 // Vårt "bil"-objekt
    let obstacles = [];      // Array av hinder
    let powerUps = [];       // Array av power-ups
    let level = 1;
    let score = 0;

    // Styrningsrelaterade
    let speed = 0;        // Nuvarande hastighet framåt
    let turnSpeed = 0;    // Vinkelhastighet (rotation)
    const maxSpeed = 0.2; // Max framåt- och bakåthastighet
    const accel = 0.01;   // Acceleration
    const decel = 0.02;   // Bromseffekt
    const turnRate = 0.02;

    // Pekskärmsvariabler för mobil
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouching = false;

    // ---------------------------------------------------
    // Initiera scenen
    // ---------------------------------------------------
    function init() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 5, 10);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Ljussättning
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
      dirLight.position.set(10, 10, 10);
      scene.add(dirLight);

      // Skapa en plan "bana" eller "mark"
      const planeGeometry = new THREE.PlaneGeometry(50, 50);
      const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      plane.rotation.x = -Math.PI / 2; // Lägg ner planet
      scene.add(plane);

      // Skapa bil (en enkel låda)
      const carGeometry = new THREE.BoxGeometry(1, 0.5, 2);
      const carMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
      car = new THREE.Mesh(carGeometry, carMaterial);
      car.position.y = 0.25; // Höj den lite över planet
      scene.add(car);

      // Lägg in de första hindren och en power-up
      spawnObstacles(level);
      spawnPowerUps(level);

      // Event Listeners
      window.addEventListener("resize", onWindowResize, false);
      window.addEventListener("keydown", onKeyDown, false);
      window.addEventListener("keyup", onKeyUp, false);

      // Touch (mobil)
      window.addEventListener("touchstart", onTouchStart, false);
      window.addEventListener("touchmove", onTouchMove, false);
      window.addEventListener("touchend", onTouchEnd, false);

      animate();
    }

    // ---------------------------------------------------
    // Skapa hinder
    // ---------------------------------------------------
    function spawnObstacles(level) {
      // Rensa tidigare hinder
      obstacles.forEach(obs => scene.remove(obs));
      obstacles = [];

      // Exempel: skapa N hinder baserat på level
      const numObstacles = level + 3;
      for (let i = 0; i < numObstacles; i++) {
        const boxGeo = new THREE.BoxGeometry(1, 1, 1);
        const boxMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        const box = new THREE.Mesh(boxGeo, boxMat);

        // Placera hindret slumpmässigt
        const xPos = (Math.random() - 0.5) * 30; // inom -15 till 15
        const zPos = (Math.random() - 0.5) * 30; // inom -15 till 15
        box.position.set(xPos, 0.5, zPos);
        scene.add(box);
        obstacles.push(box);
      }
    }

    // ---------------------------------------------------
    // Skapa power-ups
    // ---------------------------------------------------
    function spawnPowerUps(level) {
      // Rensa tidigare powerups
      powerUps.forEach(p => scene.remove(p));
      powerUps = [];

      // Exempel: en power-up per level
      for (let i = 0; i < level; i++) {
        const sphereGeo = new THREE.SphereGeometry(0.5, 16, 16);
        const sphereMat = new THREE.MeshStandardMaterial({ color: 0xffff00 });
        const sphere = new THREE.Mesh(sphereGeo, sphereMat);

        // Slumpmässig placering (se till att inte krocka exakt med hinder)
        const xPos = (Math.random() - 0.5) * 30;
        const zPos = (Math.random() - 0.5) * 30;
        sphere.position.set(xPos, 0.5, zPos);
        scene.add(sphere);
        powerUps.push(sphere);
      }
    }

    // ---------------------------------------------------
    // Inmatning - Tangentbord
    // ---------------------------------------------------
    function onKeyDown(event) {
      switch (event.key) {
        case "ArrowUp":
          // Gas
          speed = Math.min(speed + accel, maxSpeed);
          break;
        case "ArrowDown":
          // Broms/back
          speed = Math.max(speed - accel, -maxSpeed / 2);
          break;
        case "ArrowLeft":
          // Sväng vänster
          turnSpeed = -turnRate;
          break;
        case "ArrowRight":
          // Sväng höger
          turnSpeed = turnRate;
          break;
      }
    }

    function onKeyUp(event) {
      switch (event.key) {
        case "ArrowLeft":
        case "ArrowRight":
          turnSpeed = 0;
          break;
      }
    }

    // ---------------------------------------------------
    // Inmatning - Touch (mobil)
    // ---------------------------------------------------
    function onTouchStart(event) {
      if (event.touches.length === 1) {
        isTouching = true;
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
      }
    }

    function onTouchMove(event) {
      if (!isTouching || event.touches.length !== 1) return;
      const touchX = event.touches[0].clientX;
      const touchY = event.touches[0].clientY;

      // Beräkna skillnad
      const diffX = touchX - touchStartX;
      const diffY = touchY - touchStartY;

      // Exempel: Om man drar uppåt => gas, nedåt => bromsa/back, vänster/höger => sväng
      // Du kan tweaka tröskelvärdena som du vill
      const threshold = 20;
      if (Math.abs(diffY) > threshold) {
        if (diffY < 0) {
          // uppåt => gas
          speed = Math.min(speed + accel, maxSpeed);
        } else {
          // nedåt => broms/back
          speed = Math.max(speed - accel, -maxSpeed / 2);
        }
      }
      if (Math.abs(diffX) > threshold) {
        if (diffX < 0) {
          // vänster
          turnSpeed = -turnRate;
        } else {
          // höger
          turnSpeed = turnRate;
        }
      } else {
        // Om man inte drar åt sidorna tillräckligt => ingen rotation
        turnSpeed = 0;
      }
    }

    function onTouchEnd(event) {
      isTouching = false;
      turnSpeed = 0;
    }

    // ---------------------------------------------------
    // Animation/Spelloop
    // ---------------------------------------------------
    function animate() {
      requestAnimationFrame(animate);

      // Uppdatera bilens position
      // Bromsa in lite med tiden om man inte gasar
      if (!isTouching) {
        if (speed > 0) {
          speed = Math.max(speed - decel * 0.5, 0);
        } else if (speed < 0) {
          speed = Math.min(speed + decel * 0.5, 0);
        }
      }

      car.rotation.y += turnSpeed;
      const forward = new THREE.Vector3(
        Math.sin(car.rotation.y),
        0,
        Math.cos(car.rotation.y) * -1
      );
      car.position.add(forward.multiplyScalar(speed));

      // Kolla kollision med hinder
      obstacles.forEach(obs => {
        if (car.position.distanceTo(obs.position) < 1) {
          // Enkel "kollision" => backa bilen lite och nollställ speed
          speed = -0.05;
        }
      });

      // Kolla kollision med power-ups
      powerUps.forEach((p, index) => {
        if (car.position.distanceTo(p.position) < 1) {
          // Ta upp power-up
          scene.remove(p);
          powerUps.splice(index, 1);
          score += 10;
          document.getElementById('scoreText').textContent = score;
        }
      });

      // Om man plockat alla powerups -> ny level
      if (powerUps.length === 0) {
        level++;
        document.getElementById('levelText').textContent = level;
        spawnObstacles(level);
        spawnPowerUps(level);
      }

      renderer.render(scene, camera);
    }

    // ---------------------------------------------------
    // Fönster-resize
    // ---------------------------------------------------
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // ---------------------------------------------------
    // Starta spelet
    // ---------------------------------------------------
    init();
    </script>
</body>
</html>
