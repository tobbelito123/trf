<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BJJ Submissions Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0ea5e9">
<link rel="apple-touch-icon" href="icons/icon-192.png">

  <script>
  if (!/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    // Not a mobile device → redirect to desktop page
    window.location.href = "desktop.html";
  }
</script>



  <style>
    /* --- Base / Reset --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      color: var(--fg);
      background: var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    /* ensure hidden elements are really hidden everywhere */
[hidden] { display: none !important; }


    /* --- Theme --- */
    :root {
      --bg: #0b1020;
      --card: #121830;
      --card-2: #0f1428;
      --fg: #eaf1ff;
      --muted: #b7c4e1;
      --primary: #0ea5e9; /* sky */
      --primary-2: #22d3ee; /* cyan accent */
      --ring: rgba(34, 211, 238, 0.35);
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.4);
      --ok: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;

      --white: #ffffff;
      --blue: #1e40af;
      --purple: #6d28d9;
      --brown: #7c2d12;
      --black: #0b0b0b;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8ff;
        --card: #ffffff;
        --card-2: #f2f5ff;
        --fg: #0b1020;
        --muted: #475569;
        --shadow: 0 8px 24px rgba(2, 6, 23, 0.08);
      }
    }

    /* --- Layout --- */
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      min-height: 100%;
      display: grid;
      grid-template-rows: auto auto 1fr;
      padding: 16px clamp(12px, 4vw, 20px) calc(16px + env(safe-area-inset-bottom));
      gap: 14px;
    }
    .submission { touch-action: pan-y; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(180deg, rgba(34,211,238,0.06), transparent);
      border-radius: 16px;
    }
    .title {
      font-weight: 800; letter-spacing: 0.3px; font-size: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .title .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(40% 40% at 30% 30%, var(--primary-2), var(--primary));
      box-shadow: 0 0 18px var(--ring);
    }
    .actions {
      display: flex; gap: 8px; align-items: center;
    }
    .ghost {
      background: transparent; border: 1px solid rgba(148,163,184,0.25);
      color: var(--muted); padding: 8px 10px; border-radius: 10px;
      font-size: 13px;
    }

    /* --- Tabs --- */

    /* --- Tabs --- */
.tabs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  background: var(--card-2);
  border-radius: 14px;
  padding: 6px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(148,163,184,0.15);
}

.tab {
  appearance: none;
  border: 0;
  background: transparent;
  color: var(--muted);
  padding: 16px 24px;      /* bigger buttons */
  border-radius: 12px;
  font-weight: 700;
  font-size: 18px;         /* larger text */
  cursor: pointer;
  transition: all 0.2s ease;
}

.tab.active {
  color: var(--fg);
  background: linear-gradient(
    180deg,
    rgba(34,211,238,0.12),
    rgba(14,165,233,0.18)
  );
  box-shadow:
    inset 0 0 0 1px rgba(14,165,233,0.35),
    0 8px 20px rgba(2, 6, 23, 0.22);
  transform: scale(1.03);   /* subtle "pressed" look */
}


    main { display: grid; gap: 14px; }

    /* --- Cards --- */
    .grid {
      display: grid; gap: 12px;
      grid-template-columns: 1fr;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,0.12);
     
    }
      /* make the swipable content use the original 3-column grid */
.submission .content {
  display: grid;
  grid-template-columns: 72px 1fr auto;
  align-items: center;
  gap: 12px;
}

      /* swipe affordance */
.submission {
  position: relative;
  overflow: hidden;
  touch-action: pan-y; /* allow horizontal swipe without scrolling conflict */
}

.submission .swipe-bg {
  position: absolute; inset: 0;
  background: #ef4444; /* Tailwind red-500 */
  pointer-events: none;
  opacity: 0; transition: opacity .15s;
}

    .submission .swipe-bg::after {
  content: "Delete";
  position: absolute;
  right: 20px; top: 50%;
  transform: translateY(-50%);
  color: white;
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 0.5px;
}


.submission.swiping .swipe-bg { opacity: 0.9; }

.submission .content {
  position: relative;
  transition: transform .15s ease, opacity .15s ease;
  will-change: transform;
}

    .icon {
      width: 60px; height: 60px; border-radius: 16px;
      display: grid; place-items: center;
      background: radial-gradient(60% 60% at 35% 30%, rgba(34,211,238,0.4), rgba(14,165,233,0.15));
      border: 1px solid rgba(14,165,233,0.3);
    }
    .icon svg { width: 32px; height: 32px; opacity: 0.95; }
    .card h3 { margin: 0 0 6px; font-size: 16px; letter-spacing: 0.2px; }
    .muted { color: var(--muted); font-size: 13px; }
    .count {
      font-weight: 800; font-size: 20px; letter-spacing: 0.3px;
      padding: 6px 10px; border-radius: 10px; min-width: 44px; text-align: center;
      background: linear-gradient(180deg, rgba(34,211,238,0.12), rgba(14,165,233,0.18));
      border: 1px solid rgba(14,165,233,0.35);
    }
    .tap {
      display: inline-block; margin-top: 6px;
      font-size: 12px; color: var(--primary-2); opacity: 0.9;
    }

    /* --- Belt sheet (bottom sheet) --- */
    .sheet-backdrop {
      position: fixed; inset: 0; background: rgba(2,6,23,0.4);
      opacity: 0; pointer-events: none; transition: opacity .2s ease;
    }
    .sheet {
      position: fixed; left: 0; right: 0; bottom: 0;
      transform: translateY(100%);
      transition: transform .3s ease;
      background: var(--card);
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -10px 30px rgba(2, 6, 23, 0.4);
      border-top: 1px solid rgba(148,163,184,0.18);
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop.open { opacity: 1; pointer-events: auto; }
    .sheet h4 { margin: 4px 2px 10px; font-size: 15px; }
    .belts {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
    }
    .belt {
      appearance: none; border: 0; border-radius: 12px; padding: 12px 8px;
      background: var(--card-2);
      color: var(--fg);
      font-weight: 700; font-size: 12px; letter-spacing: 0.2px;
      border: 1px solid rgba(148,163,184,0.16);
    }
    .belt .swatch {
      display: block; height: 16px; border-radius: 6px; margin-bottom: 8px;
      border: 1px solid rgba(0,0,0,0.2);
    }
    .belt[data-belt="white"] .swatch { background: var(--white); }
    .belt[data-belt="blue"] .swatch { background: var(--blue); }
    .belt[data-belt="purple"] .swatch { background: var(--purple); }
    .belt[data-belt="brown"] .swatch { background: var(--brown); }
    .belt[data-belt="black"] .swatch { background: var(--black); }

    .sheet .hint { margin-top: 10px; color: var(--muted); font-size: 12px; }

    /* --- Stats --- */
    .stat-card { padding: 16px; background: var(--card); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid rgba(148,163,184,0.12); }
    .stat-head { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; }
    .stat-head h3 { margin: 0; font-size: 15px; }
    .stat-head .total { font-weight: 800; }
    .bar {
      height: 12px; border-radius: 10px; display: grid; grid-auto-flow: column; overflow: hidden;
      margin-top: 10px; outline: 1px solid rgba(148,163,184,0.18);
    }
    .seg { height: 100%; }
    .seg.white { background: linear-gradient(180deg, #fff, #e5e7eb); }
    .seg.blue { background: linear-gradient(180deg, #3b82f6, #1e40af); }
    .seg.purple { background: linear-gradient(180deg, #a78bfa, #6d28d9); }
    .seg.brown { background: linear-gradient(180deg, #b45309, #7c2d12); }
    .seg.black { background: linear-gradient(180deg, #111827, #0b0b0b); }
    .legend {
      margin-top: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; font-size: 12px; color: var(--muted);
    }
    .chip { display: flex; gap: 6px; align-items: center; }
    .dot { width: 10px; height: 10px; border-radius: 999px; }
    .dot.white { background: #fff; outline: 1px solid #cbd5e1; }
    .dot.blue { background: #1e40af; }
    .dot.purple { background: #6d28d9; }
    .dot.brown { background: #7c2d12; }
    .dot.black { background: #0b0b0b; outline: 1px solid #e5e7eb; }

    /* --- Footer row --- */
    .foot {
      display: flex; gap: 10px; justify-content: space-between; align-items: center;
      margin-top: 2px; color: var(--muted); font-size: 12px;
    }
    .reset {
      background: transparent; border: 1px solid rgba(239,68,68,0.35); color: #fecaca;
      padding: 8px 10px; border-radius: 10px; font-size: 12px;
    }

    /* --- Toast --- */
    .toast {
      position: fixed; left: 50%; bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(16px);
      background: rgba(15, 23, 42, 0.9);
      color: #e2f7f6; padding: 10px 14px; border-radius: 12px;
      border: 1px solid rgba(34,211,238,0.35);
      box-shadow: var(--shadow);
      opacity: 0; transition: opacity .2s ease, transform .2s ease;
      font-size: 13px; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><span class="dot"></span> BJJ Submissions Tracker</div>
      <div class="actions">
        <button class="ghost" id="addBtn" title="Add a submission">+ Add</button>
        <button class="ghost" id="sortBtn" title="Toggle sorting" aria-pressed="false"><> Sort</button>
  <button class="ghost" id="infoBtn" title="Info">ℹ️ Info</button>

      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Views">
      <button class="tab active" data-tab="log" role="tab" aria-selected="true">Log</button>
      <button class="tab" data-tab="stats" role="tab" aria-selected="false">Stats</button>
    </nav>

    <main>
      <!-- Log view -->
      <section id="view-log" class="grid" role="tabpanel" aria-labelledby="tab-log">
        <!-- Armbar from guard -->
<button class="card submission" data-submission="armbar_from_guard" aria-label="Log Armbar from guard">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M3 12c2-2 6-6 9-6 5 0 7 6 7 6s-2 6-7 6c-3 0-7-4-9-6z" stroke-width="1.5"/>
        <path d="M9 10l6 4" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Armbar from guard</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-armbar_from_guard">0</div>
  </div>
</button>

<!-- Triangle from guard -->
<button class="card submission" data-submission="triangle_from_guard" aria-label="Log Triangle from guard">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M12 4l8 14H4L12 4z" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Triangle from guard</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-triangle_from_guard">0</div>
  </div>
</button>

<!-- Kimura from guard -->
<button class="card submission" data-submission="kimura_from_guard" aria-label="Log Kimura from guard">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M5 12c2-3 5-5 7-5 3 0 5 2 7 5" stroke-width="1.5"/>
        <path d="M9 13l6-2" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Kimura from guard</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-kimura_from_guard">0</div>
  </div>
</button>

<!-- Americana from side -->
<button class="card submission" data-submission="americana_from_side" aria-label="Log Americana from side">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="5" y="6" width="14" height="12" rx="3" stroke-width="1.5"/>
        <path d="M9 12h6" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Americana from side</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-americana_from_side">0</div>
  </div>
</button>

<!-- Rear naked choke -->
<button class="card submission" data-submission="rear_naked_choke" aria-label="Log Rear naked choke">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="7" r="3" stroke-width="1.5"/>
        <path d="M7 21c0-3.5 2.5-6 5-6s5 2.5 5 6" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Rear naked choke</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-rear_naked_choke">0</div>
  </div>
</button>

<!-- Crosscollar from mount -->
<button class="card submission" data-submission="crosscollar_from_mount" aria-label="Log Crosscollar from mount">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M6 6l12 12M18 6L6 18" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Crosscollar from mount</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-crosscollar_from_mount">0</div>
  </div>
</button>

<!-- Ankle lock -->
<button class="card submission" data-submission="ankle_lock" aria-label="Log Ankle lock">
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M7 15c2 1 4 2 6 2 3 0 4-2 4-4" stroke-width="1.5"/>
        <path d="M7 18c2 2 5 3 8 3" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>Ankle lock</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-ankle_lock">0</div>
  </div>
</button>
<div class="foot"></div>
      </section>

      <!-- Stats view -->
      <section id="view-stats" hidden role="tabpanel" aria-labelledby="tab-stats">
        <div id="statsList" class="grid"></div>
      </section>
    </main>
  </div>

  <!-- Bottom sheet for belt selection -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="beltSheet" aria-modal="true" role="dialog" aria-labelledby="sheetTitle">
    <h4 id="sheetTitle">Who did you hit it against?</h4>
    <div class="belts" role="group" aria-label="Opponent belt">
      <button class="belt" data-belt="white"><span class="swatch"></span>White</button>
      <button class="belt" data-belt="blue"><span class="swatch"></span>Blue</button>
      <button class="belt" data-belt="purple"><span class="swatch"></span>Purple</button>
      <button class="belt" data-belt="brown"><span class="swatch"></span>Brown</button>
      <button class="belt" data-belt="black"><span class="swatch"></span>Black</button>
    </div>
    <div class="hint">Tap a belt to log 1 sub for the selected submission.</div>
  </div>
<!-- Info Sheet -->
<div class="sheet-backdrop" id="infoBackdrop"></div>
<div class="sheet" id="infoSheet" aria-modal="true" role="dialog" aria-labelledby="infoTitle">
  <h4 id="infoTitle">App Info</h4>
  <p>This app stores your submissions per belt locally in your browser’s cache (localStorage).  
Data stays on this device and works offline. It’s not synced anywhere.</p>
<p>You can also install it as an app:  
On Android, Chrome may suggest it automatically.  
On iPhone, open Safari’s Share menu → “Add to Home Screen.”</p>

  <p>You can export to JSON for backup, and import that JSON file to restore. Reset wipes all counts.</p>
  <div style="margin-top:14px;display:flex;flex-direction:column;gap:8px;">
    <button class="reset" id="resetBtn">Reset all data</button>
    <button class="ghost" id="exportBtn">Export</button>
    <button class="ghost" id="importBtn">Import</button>
  </div>
</div>

  <!-- Toast -->
  <div class="toast" id="toast">Saved</div>

  <script>
    // ------- Storage & Data -------
    const KEY = "bjj-submissions-v1";
    const SUBMISSIONS = [
  "armbar_from_guard",
  "triangle_from_guard",
  "kimura_from_guard",
  "americana_from_side",
  "rear_naked_choke",
  "crosscollar_from_mount",
  "ankle_lock"
];
    const LABELS = {
  armbar_from_guard: "Armbar from guard",
  triangle_from_guard: "Triangle from guard",
  kimura_from_guard: "Kimura from guard",
  americana_from_side: "Americana from side",
  rear_naked_choke: "Rear naked choke",
  crosscollar_from_mount: "Crosscollar from mount",
  ankle_lock: "Ankle lock"
};
    const BELTS = ["white","blue","purple","brown","black"];

    function defaultData() {
  const zero = { white:0, blue:0, purple:0, brown:0, black:0 };
  return {
    submissions: {
      armbar_from_guard: { ...zero },
      triangle_from_guard: { ...zero },
      kimura_from_guard: { ...zero },
      americana_from_side: { ...zero },
      rear_naked_choke: { ...zero },
      crosscollar_from_mount: { ...zero },
      ankle_lock: { ...zero }
    }
  };
}

    function readData() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) return defaultData();
        const parsed = JSON.parse(raw);
        // Ensure all keys exist (future-proof)
        const base = defaultData();
        for (const s of SUBMISSIONS) {
          parsed.submissions ??= {};
          parsed.submissions[s] ??= {...base.submissions[s]};
          for (const b of BELTS) parsed.submissions[s][b] ??= 0;
        }
        return parsed;
      } catch {
        return defaultData();
      }
    }

    function writeData(data) {
      localStorage.setItem(KEY, JSON.stringify(data));
    }

    // ------- UI helpers -------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function vibrate(ms=12){ if (navigator.vibrate) try { navigator.vibrate(ms); } catch {} }
    function toast(msg) {
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1200);
    }

    // ------- State -------
    let DATA = readData();
    let pendingSubmission = null;

    // Update counts on cards
    function totalFor(sub) {
      const o = DATA.submissions[sub];
      return BELTS.reduce((n,b) => n + (o[b]||0), 0);
    }
    function sortedSubmissions() {
  // No auto-sort; use SUBMISSIONS as-is.
  return [...SUBMISSIONS];
}

    function sortNow() {
  // Create the desired order once
  const sorted = [...SUBMISSIONS].sort((a, b) => totalFor(b) - totalFor(a));
  // Overwrite the SUBMISSIONS array so future refreshes keep this order
  SUBMISSIONS.length = 0;
  SUBMISSIONS.push(...sorted);
  // Re-render
  refreshCards();
  if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
  toast("Sorted by total hits");
}


   function refreshCards() {
  const grid = document.getElementById("view-log");
  const foot = grid.querySelector(".foot");
  const subs = sortedSubmissions();

  subs.forEach((s) => {
    const el = document.getElementById("count-" + s);
    if (el) el.textContent = totalFor(s);

    // Reorder card in DOM
    const card = grid.querySelector(`[data-submission="${s}"]`);
    if (card) grid.insertBefore(card, foot);
  });
}


    // Build stats list
    function buildStats() {
      const list = $("#statsList");
      list.innerHTML = "";
      for (const s of sortedSubmissions()) {
        const totals = DATA.submissions[s];
        const sum = totalFor(s);
        const frag = document.createElement("div");
        frag.className = "stat-card";
        const pct = b => sum ? Math.round((totals[b]/sum)*100) : 0;

        // Build bar segments
        const bar = document.createElement("div");
        bar.className = "bar";
        for (const b of BELTS) {
          const seg = document.createElement("div");
          seg.className = "seg " + b;
          seg.style.width = (sum ? (totals[b]/sum*100) : 0) + "%";
          bar.appendChild(seg);
        }

        // Legend items
        const legend = document.createElement("div");
        legend.className = "legend";
        for (const b of BELTS) {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.innerHTML = `<span class="dot ${b}"></span>${b[0].toUpperCase()+b.slice(1)} ${sum?`· ${totals[b]} (${pct(b)}%)`:"· 0 (0%)"}`;
          legend.appendChild(chip);
        }

        frag.innerHTML = `
          <div class="stat-head">
            <h3>${LABELS[s]}</h3>
            <div class="total">${sum}</div>
          </div>
        `;
        frag.appendChild(bar);
        frag.appendChild(legend);
        list.appendChild(frag);
      }
    }

    // ------- Belt sheet -------
    const sheet = $("#beltSheet");
    const backdrop = $("#sheetBackdrop");
    function openSheet(forSubmission) {
      pendingSubmission = forSubmission;
      $("#sheetTitle").textContent = `Who did you hit ${LABELS[forSubmission]} against?`;
      sheet.classList.add("open");
      backdrop.classList.add("open");
    }
    function closeSheet() {
      sheet.classList.remove("open");
      backdrop.classList.remove("open");
      setTimeout(() => { pendingSubmission = null; }, 150);
    }
    backdrop.addEventListener("click", closeSheet);

// Handle submission cards (tap + swipe to delete)
// Safer tap handler: only open if no scroll/drag happened
function attachSafeTap(btn, key) {
  let startX = 0, startY = 0, moved = false;

  btn.addEventListener("touchstart", (e) => {
    const t = e.touches[0];
    startX = t.clientX; startY = t.clientY;
    moved = false;
  }, { passive: true });

  btn.addEventListener("touchmove", (e) => {
    const t = e.touches[0];
    if (Math.abs(t.clientY - startY) > 10 || Math.abs(t.clientX - startX) > 10) {
      moved = true; // treat as scroll/drag, not a tap
    }
  }, { passive: true });

  btn.addEventListener("touchend", () => {
    if (!moved) { openSheet(key); vibrate(8); }
  });

  // Desktop / non-touch fallback
  btn.addEventListener("click", (e) => {
    // On touch devices, click will fire after touchend too; ignore because touchend already handled
    if ("ontouchstart" in window) return;
    openSheet(key); vibrate(8);
  });
}

// Attach to all existing hard-coded cards
$$(".submission").forEach(btn => {
  const key = btn.dataset.submission;
  attachSafeTap(btn, key);
  attachSwipeToDelete(btn, key);
});


    // Handle belt selection
    $$(".belt").forEach(b => {
      b.addEventListener("click", () => {
        const belt = b.dataset.belt;
        if (!pendingSubmission) return;
        DATA.submissions[pendingSubmission][belt] += 1;
        writeData(DATA);
        refreshCards();
        // If stats tab is visible, update it too
        if (!$("#view-stats").hasAttribute("hidden")) buildStats();
        toast(`+1 ${LABELS[pendingSubmission]} vs ${belt[0].toUpperCase()+belt.slice(1)} belt`);
        vibrate(12);
        closeSheet();
      });
    });

    // ------- Tabs -------
    const tabs = $$(".tab");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const show = t.dataset.tab;
      if (show === "log") {
        $("#view-log").hidden = false;
        $("#view-stats").hidden = true;
      } else {
        $("#view-log").hidden = true;
        $("#view-stats").hidden = false;
        buildStats();
      }
    }));

    // ------- Reset / Import / Export -------
    $("#resetBtn").addEventListener("click", () => {
      if (confirm("Reset all counts? This cannot be undone.")) {
        DATA = defaultData();
        writeData(DATA);
        refreshCards();
        if (!$("#view-stats").hasAttribute("hidden")) buildStats();
        toast("All data reset");
        vibrate(20);
      }
    });

    $("#exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(DATA, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "bjj-submissions.json";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 0);
    });

    $("#importBtn").addEventListener("click", async () => {
      const input = document.createElement("input");
      input.type = "file"; input.accept = "application/json";
      input.onchange = () => {
        const file = input.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const obj = JSON.parse(String(reader.result));
            if (!obj?.submissions) throw new Error("Invalid file");
            DATA = obj;
            writeData(DATA);
            refreshCards();
            if (!$("#view-stats").hasAttribute("hidden")) buildStats();
            toast("Import successful");
            vibrate(16);
          } catch {
            alert("Could not import that file.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    // Make a safe key from a label (e.g., "Rear Naked Choke" -> "rear_naked_choke")
function slugify(label) {
  return label
    .toLowerCase()
    .replace(/[^\w\s-]/g, "")
    .trim()
    .replace(/\s+/g, "_");
}

// Create a new submission card element and wire its click handler
function renderCard(key) {
  // skip if it already exists
  if (document.getElementById("count-" + key)) return;

  const grid = document.querySelector("#view-log.grid");
  const beforeFoot = grid.querySelector(".foot");

  const card = document.createElement("button");
  card.className = "card submission";
  card.dataset.submission = key;
  card.setAttribute("aria-label", "Log " + (LABELS[key] || key));

card.innerHTML = `
  <div class="swipe-bg"></div>
  <div class="content">
    <div class="icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="8" stroke-width="1.5"/>
        <path d="M8 12h8" stroke-width="1.5"/>
      </svg>
    </div>
    <div>
      <h3>${LABELS[key] || key}</h3>
      <div class="muted">Tap to log vs belt</div>
    </div>
    <div class="count" id="count-${key}">0</div>
  </div>
`;


  // same behavior as your existing cards
  card.addEventListener("click", () => {
    openSheet(key);
    vibrate(8);
  });
  


  grid.insertBefore(card, beforeFoot);
  attachSafeTap(card, key);
  attachSwipeToDelete(card, key);
}

 function attachSwipeToDelete(cardEl, key) {
  const content = cardEl.querySelector('.content');
  const CLICK_OPEN_SHEET_DELTA = 14;     // tap threshold (was 8)
  const DELETE_THRESHOLD = 96;           // px to trigger delete

  let startX = 0, startY = 0;
  let currentX = 0, currentY = 0;
  let dragging = false;

  function onStart(e) {
    const touch = e.touches ? e.touches[0] : e;
    startX = currentX = touch.clientX;
    startY = currentY = touch.clientY;   // NEW: track Y too
    dragging = true;
    cardEl.classList.add('swiping');
  }

  function onMove(e) {
    if (!dragging) return;
    const touch = e.touches ? e.touches[0] : e;
    currentX = touch.clientX;
    currentY = touch.clientY;            // NEW
    const dx = Math.min(0, currentX - startX); // only allow swiping left
    content.style.transform = `translateX(${dx}px)`;
    content.style.opacity = `${1 - Math.min(Math.abs(dx) / 220, 0.25)}`;
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    const dx = currentX - startX;
    const dy = currentY - startY;        // NEW

    // Treat as TAP only if movement is tiny in BOTH axes
    if (Math.abs(dx) < CLICK_OPEN_SHEET_DELTA && Math.abs(dy) < CLICK_OPEN_SHEET_DELTA) {
      content.style.transform = '';
      content.style.opacity = '';
      cardEl.classList.remove('swiping');
      openSheet(key);
      vibrate(8);
      return;
    }

    // Strong left swipe → delete flow
    if (dx <= -DELETE_THRESHOLD) {
      const ok = confirm(
  `Delete "${LABELS[key] || key}"?\n\n` +
  `This removes it from this device and from future JSON exports. ` +
  `Any JSON backups you've already exported will not change.`
);
      if (ok) {
        const i = SUBMISSIONS.indexOf(key);
        if (i >= 0) SUBMISSIONS.splice(i, 1);
        delete DATA.submissions[key];
        writeData(DATA);
        cardEl.remove();
        if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();
        toast(`Deleted ${LABELS[key] || key}`);
        vibrate(20);
        return;
      }
    }

    // Otherwise, snap back
    content.style.transform = '';
    content.style.opacity = '';
    cardEl.classList.remove('swiping');
  }

  cardEl.addEventListener('touchstart', onStart, { passive: true });
  cardEl.addEventListener('touchmove', onMove,  { passive: true });
  cardEl.addEventListener('touchend', onEnd);
  cardEl.addEventListener('touchcancel', onEnd);
}



// Ensure DATA has a zeroed belt map for a key
function ensureZeroed(key) {
  const zero = { white:0, blue:0, purple:0, brown:0, black:0 };
  if (!DATA.submissions[key]) DATA.submissions[key] = { ...zero };
}

// Add a new submission via prompt
function addSubmissionFlow() {
  const name = (prompt("Submission name (e.g., Triangle):") || "").trim();
  if (!name) return;

  let key = slugify(name);
  if (!key) return alert("That name doesn’t produce a valid key.");

  // Ensure uniqueness (triangle, triangle_2, ...)
  let base = key, i = 2;
  while (SUBMISSIONS.includes(key)) { key = `${base}_${i++}`; }

  // Update in-memory structures
  SUBMISSIONS.push(key);
  LABELS[key] = name;
  ensureZeroed(key);

  // Persist
  writeData(DATA);

  // Render a new card and update counts/stats
  renderCard(key);
  refreshCards();
  if (!document.getElementById("view-stats").hasAttribute("hidden")) buildStats();

  toast(`Added "${name}"`);
  vibrate(12);
}


    // ------- Init -------
    // Render cards for dynamically added submissions (beyond the 3 hardcoded)
SUBMISSIONS.forEach((key) => {
  if (!document.getElementById("count-" + key)) {
    // Make sure DATA has storage for it
    ensureZeroed(key);
    renderCard(key);
  }
});

    refreshCards();

    document.getElementById("addBtn").addEventListener("click", addSubmissionFlow);
    document.getElementById("sortBtn").addEventListener("click", sortNow);

    // ------- Info sheet -------
const infoSheet = document.getElementById("infoSheet");
const infoBackdrop = document.getElementById("infoBackdrop");
document.getElementById("infoBtn").addEventListener("click", () => {
  infoSheet.classList.add("open");
  infoBackdrop.classList.add("open");
});
infoBackdrop.addEventListener("click", () => {
  infoSheet.classList.remove("open");
  infoBackdrop.classList.remove("open");
});


    
  </script>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>

</body>
</html>
